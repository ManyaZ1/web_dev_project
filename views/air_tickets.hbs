<div id="globeViz"></div>

<div class="floating-form-box">
    <h2>Your Flight</h2>
    <form id="flightForm" method="GET" action="/tickets">
        <!-- From / To -->
        <div class="form-grid-2">
            <div>
                <label for="fromInput">From:</label>
                <select id="fromInput" name="fromInput" required>
                    <option value="">Select</option>
                </select>
            </div>
            <div>
                <label for="toInput">To:</label>
                <select id="toInput" name="toInput" required>
                    <option value="">Select</option>
                </select>
            </div>
        </div>

        <!-- Trip Type -->
        <label for="tripType">Trip Type:</label>
        <select id="tripType" name="tripType" required>
            <option value="oneway">One-way</option>
            <option value="roundtrip">Round-trip</option>
        </select>

        <!-- Date Range Picker -->
        <div class="date-range-picker">
            <div class="date-field">
                <label for="departureDate">
                    <span class="calendar-icon">ðŸ“…</span> Departure
                </label>
                <input type="text" id="departureDate" name="departureDate" required />
            </div>
            <div class="divider"></div>
            <div class="date-field return-field" id="returnDateContainer">
                <label for="returnDate">
                    <span class="calendar-icon">ðŸ“…</span> Return
                </label>
                <input type="text" id="returnDate" name="returnDate" />
            </div>
        </div>

        <!-- Class -->
        <label for="class">Class:</label>
        <select id="class" name="class" required>
            <option>Economy</option>
            <option>Business</option>
            <option>First</option>
        </select>

        <!-- Adults / Children -->
        <div class="form-grid-2">
            <div>
                <label for="adults">Adults:</label>
                <input type="number" id="adults" name="adults" value="1" min="1" required />
            </div>
            <div>
                <label for="children">Children:</label>
                <input type="number" id="children" name="children" value="0" min="0" required />
            </div>
        </div>

        <!-- Max Price -->
        <label>Max Price (optional):</label>
        <input type="number" name="maxPrice" min="1" />

        <!-- Submit -->
        <div class="button-row">
            <button id="checkBtn" type="submit">Search Flights</button>
        </div>
    </form>
</div>

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<!-- Load Globe and Three.js Libraries -->
<script src="https://unpkg.com/three"></script>
<script src="https://unpkg.com/globe.gl"></script>
<script src="/js/globe.js"></script>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Smooth Animation for Return Date -->
<style>
    #returnDateContainer {
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        transition: opacity 0.5s ease, max-height 0.5s ease;
    }

    #returnDateContainer.show {
        opacity: 1;
        max-height: 100px;
    }
</style>

<script>
    async function loadCities() {
        try {
            const response = await fetch('/api/cities');
            if (!response.ok) throw new Error('Failed to fetch cities');

            const cities = await response.json();
            const fromSelect = document.getElementById('fromInput');
            const toSelect = document.getElementById('toInput');

            cities.forEach(city => {
                const optionFrom = document.createElement('option');
                optionFrom.value = city;
                optionFrom.textContent = city;

                const optionTo = optionFrom.cloneNode(true);

                fromSelect.appendChild(optionFrom);
                toSelect.appendChild(optionTo);
            });
        } catch (error) {
            console.error('Error loading cities:', error);
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        loadCities();

        const returnContainer = document.getElementById('returnDateContainer');
        const tripTypeSelect = document.getElementById('tripType');
        const returnDateInput = document.getElementById('returnDate');

        const departurePicker = flatpickr("#departureDate", {
            minDate: "today",
            onChange: function(selectedDates) {
                const minReturn = selectedDates[0] ? selectedDates[0].fp_incr(1) : "today";
                returnPicker.set("minDate", minReturn);
            }
        });

        const returnPicker = flatpickr("#returnDate", { minDate: "today" });

        function updateReturnDateVisibility() {
            if (tripTypeSelect.value === 'roundtrip') {
                returnContainer.classList.add('show');
            } else {
                returnContainer.classList.remove('show');
                returnDateInput.value = "";
            }
        }

        tripTypeSelect.addEventListener('change', updateReturnDateVisibility);
        updateReturnDateVisibility();
    });
</script>
